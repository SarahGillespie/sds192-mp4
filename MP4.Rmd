---
title: "MP4"
author: "Sarah Gillespie, Berry Williams, Eva Putnam"
date: "2019-05-04"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r StartingItems, message=FALSE, warning = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(GGally)
library(network)
library(sna)
library(sf)
library(leaflet)
library(lwgeom)
library(wordcountaddin)
library(lubridate)
```

#package required for network graphic: "GGally". Dependencies: "network", "sna"

```{r SQLData, message=FALSE, warning = FALSE}
library(RMySQL)
db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")

class(db)

```
### Notes
### Mimic the Wonder Woman article
# i really like the station_summary that shows the most popular stations
# we could count the number of rides total and by station.

#trip_summary just shows an increasing number of people are using the bikes. Heartening but not particularly insightful.
#try for a single bike then see where it goes
# somebody else did analysis on this but using Python: https://towardsdatascience.com/citi-bike-2017-analysis-efd298e6c22c
```{r ActiveCode 2, message=FALSE, warning = FALSE}
db %>%
  dbGetQuery("SHOW TABLES;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_months
             LIMIT 0, 100;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_summary
             LIMIT 0, 100;")
db %>%
  dbGetQuery("SELECT * 
             FROM trip_summary
             LIMIT 0, 20;")

db %>%
  dbGetQuery("SELECT * 
              FROM trips
              LIMIT 0, 200;")

```

```{r ActiveCode 3, message=FALSE, warning = FALSE}
#network of start and ending destinations by user type
#documentation on networks: https://briatte.github.io/ggnet/ , #https://cran.r-project.org/web/packages/ggnetwork/vignettes/ggnetwork.html

tripsTable <- db %>%
  dbGetQuery("SELECT * 
              FROM trips
              LIMIT 0, 200;")

network(tripsTable)

#color = user_type
```

#### Questions: let's go at this from a business perspective. Are most bike riders customers or subscribers, age, gender. How can we get more people to ride the bikes? What geographic location do the bikes start and end?

```{r ActiveCode 1, message=FALSE, warning = FALSE}

joinedTable <- db %>%
  dbGetQuery("SELECT
                station_months.station_id AS smonID, station_months.name AS smonName, station_months.num_starts AS smonNumStarts, station_months.num_stops AS smonNumStops, station_summary.num_months AS ssumNumMonths, station_summary.num_starts AS ssumNumStarts, station_summary.num_stops AS ssumNumStops
              FROM
                station_months
                  LEFT JOIN
                station_summary ON station_months.station_id = station_summary.station_id;")
```

```{r plot, message=FALSE, warning = FALSE}
ggplot(joinedTable, aes(x = ssumNumMonths, y = ssumNumStarts, group = smonName)) + 
  geom_col() +
  geom_text(data=subset(joinedTable, ssumNumStarts > 150000),
            aes(ssumNumMonths, y = ssumNumStarts,label= smonName))

# the above isn't right but I can't tell how its wrong
```

```{r import bike stations data, message=FALSE, warning = FALSE}

bikeStations <- db %>%
  dbGetQuery("SELECT * 
             FROM station_summary
             LIMIT 0, 100;")
```

```{r car crash data import, message = FALSE, warning = FALSE}
nyc_crashes <- read_csv("NYPD_Motor_Vehicle_Collisions.csv")
```

```{r rename stupidly named columns, message = FALSE, warning = FALSE}
colnames(nyc_crashes)[15] <- "bike_injuries"
colnames(nyc_crashes)[16] <- "bike_deaths"
```

```{r filter for bike crashes only, message = FALSE, warning = FALSE}
nyc_crashes_bike <- nyc_crashes %>%
  filter(bike_injuries > 0 | bike_deaths > 0) 
```


```{r wrangle and dateify crash data, message = FALSE, warning = FALSE}
bike_crashes_tidy <- nyc_crashes_bike %>%
  dplyr::select(DATE, LONGITUDE, LATITUDE, bike_injuries, bike_deaths) %>%
  dplyr::mutate(FullDate = mdy(DATE)) %>%
  separate(FullDate, sep="-", into = c("year", "month", "day")) %>%
  filter(year == 2019, LONGITUDE != 0, LATITUDE != 0)
```


```{r make icons, message = FALSE, warning = FALSE}
bike_icon <-makeIcon("bike_icon.svg")
```

```{r map, message = FALSE, warning = FALSE}
leaflet(bikeStations) %>%
  addTiles() %>%
  addMarkers(~lon, ~lat, icon = bike_icon) %>%
  addCircles(~bike_crashes_tidy$LONGITUDE, bike_crashes_tidy$LATITUDE, weight = 1, radius = 40,
             fill = ~bike_crashes_tidy$bike_deaths, stroke = TRUE, fillOpacity = 1)
```

^[[Github Repository](https://github.com/SarahGillespie/sds192-mp4)
]
