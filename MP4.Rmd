---
title: "MP4"
author: "Sarah Gillespie, Berry Williams, Eva Putman"
date: "2019-05-04"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r StartingItems, message=FALSE, warning = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(GGally)
library(network)
library(sna)
library(sf)
library(leaflet)
library(lwgeom)
library(wordcountaddin)
```

#package required for network graphic: "GGally". Dependencies: "network", "sna"

```{r SQLData, message=FALSE, warning = FALSE}
library(RMySQL)
db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")

class(db)

```
### Notes
### Mimic the Wonder Woman article
# i really like the station_summary that shows the most popular stations
# we could count the number of rides total and by station.

#trip_summary just shows an increasing number of people are using the bikes. Heartening but not particularly insightful.
#try for a single bike then see where it goes
# somebody else did analysis on this but using Python: https://towardsdatascience.com/citi-bike-2017-analysis-efd298e6c22c
```{r ActiveCode, message=FALSE, warning = FALSE}
db %>%
  dbGetQuery("SHOW TABLES;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_months
             LIMIT 0, 100;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_summary
             LIMIT 0, 100;")
db %>%
  dbGetQuery("SELECT * 
             FROM trip_summary
             LIMIT 0, 20;")

db %>%
  dbGetQuery("SELECT * 
              FROM trips
              LIMIT 0, 200;")

```

```{r ActiveCode, message=FALSE, warning = FALSE}
#network of start and ending destinations by user type
#documentation on networks: https://briatte.github.io/ggnet/ , #https://cran.r-project.org/web/packages/ggnetwork/vignettes/ggnetwork.html

tripsTable <- db %>%
  dbGetQuery("SELECT * 
              FROM trips
              LIMIT 0, 200;")

network(tripsTable)

#color = user_type
```

#### Questions: let's go at this from a business perspective. Are most bike riders customers or subscribers, age, gender. How can we get more people to ride the bikes? What geographic location do the bikes start and end?

```{r ActiveCode, message=FALSE, warning = FALSE}

joinedTable <- db %>%
  dbGetQuery("SELECT
                station_months.station_id AS smonID, station_months.name AS smonName, station_months.num_starts AS smonNumStarts, station_months.num_stops AS smonNumStops, station_summary.num_months AS ssumNumMonths, station_summary.num_starts AS ssumNumStarts, station_summary.num_stops AS ssumNumStops
              FROM
                station_months
                  LEFT JOIN
                station_summary ON station_months.station_id = station_summary.station_id;")
```

```{r plot, message=FALSE, warning = FALSE}
ggplot(joinedTable, aes(x = ssumNumMonths, y = ssumNumStarts, group = smonName)) + 
  geom_col() +
  geom_text(data=subset(joinedTable, ssumNumStarts > 150000),
            aes(ssumNumMonths, y = ssumNumStarts,label= smonName))

# the above isn't right but I can't tell how its wrong
```


```{r map, message=FALSE, warning = FALSE}

bikeStations <- db %>%
  dbGetQuery("SELECT * 
             FROM station_summary
             LIMIT 0, 100;")


new_campsite<- tribble(
  ~name, ~lat, ~lon,
  "New campsite 1", 42.448483, -72.675119,
  "New campsite 2", 42.447339, -72.675275)

leaflet(bikeStations) %>%
  addTiles() %>%
  addCircles(~lon, ~lat, popup=bikeStations$type, weight = 3, radius=40, 
                 color="#000000", stroke = TRUE, fillOpacity = 0.8)

```

^[[Github Repository](https://github.com/SarahGillespie/sds192-mp4)
]
