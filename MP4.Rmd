---
title: "MP4"
author: "Sarah Gillespie, Berry Williams, Eva Putnam"
date: "2019-05-04"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r StartingItems, message=FALSE, warning = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(GGally)
library(network)
library(sna)
library(sf)
library(leaflet)
library(lwgeom)
library(wordcountaddin)
library(lubridate)
library(rtweet)
library(RColorBrewer)
```
```

#package required for network graphic: "GGally". Dependencies: "network", "sna"

```{r SQLData, message=FALSE, warning = FALSE}
library(RMySQL)
db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")

class(db)

```
### Text
```{r lookAtTheTables, message=FALSE, warning = FALSE}
db %>%
  dbGetQuery("SHOW TABLES;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_months
             LIMIT 0, 100;")

db %>%
  dbGetQuery("SELECT * 
             FROM station_summary
             LIMIT 0, 100;")

bikeStations <- db %>%
  dbGetQuery("SELECT *
             FROM station_summary;")

bikeStations <- bikeStations %>%
  filter(num_months > 8)

```

```{r UseNetwork, message=FALSE, warning = FALSE}
#network of start and ending destinations by user type
#documentation on networks: https://briatte.github.io/ggnet/ , #https://cran.r-project.org/web/packages/ggnetwork/vignettes/ggnetwork.html

tripsTable <- db %>%
  dbGetQuery("SELECT * 
              FROM trips
              LIMIT 0, 100;")

network(tripsTable)

```

#### Questions: let's go at this from a business perspective. Are most bike riders customers or subscribers, age, gender. How can we get more people to ride the bikes? What geographic location do the bikes start and end?

```{r joinSQLtables, message=FALSE, warning = FALSE}

joinedTable <- db %>%
  dbGetQuery("SELECT
                station_months.station_id AS smonID, station_months.name AS smonName, station_months.num_starts AS smonNumStarts, station_months.num_stops AS smonNumStops, station_summary.num_months AS ssumNumMonths, station_summary.num_starts AS ssumNumStarts, station_summary.num_stops AS ssumNumStops
              FROM
                station_months
                  LEFT JOIN
                station_summary ON station_months.station_id = station_summary.station_id;")
```

```{r ggplotViaDplyr, message=FALSE, warning = FALSE}
joinedTableSimple <- db %>%
  dbGetQuery("SELECT
                station_months.station_id AS smonID, station_months.name AS smonName, station_summary.num_months AS ssumNumMonths, station_summary.num_starts AS ssumNumStarts, station_summary.num_stops AS ssumNumStops
              FROM
                station_months
                  LEFT JOIN
                station_summary ON station_months.station_id = station_summary.station_id;")

joinedTableUniques <- joinedTableSimple %>%
  distinct()

joinedTableUniques <- joinedTableUniques %>%
  mutate(AverageMonthyUsers = (ssumNumStarts/ssumNumMonths)) %>%
  filter(ssumNumMonths == "12") %>%
  mutate(TotalCitiStarts = sum(ssumNumStarts)) %>%
  mutate(PercentOfTotal = (ssumNumStarts / TotalCitiStarts)) %>%
  arrange((desc(PercentOfTotal))) %>%
  filter(PercentOfTotal > 0.00375)

joinedTableUniques$PercentOfTotal <- joinedTableUniques$PercentOfTotal * 100

```

```{r IndividualStations, message=FALSE, warning = FALSE}

ggplot(joinedTableUniques, aes(x = reorder(smonName, PercentOfTotal), y = PercentOfTotal)) + 
  geom_col(fill = "blue") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  xlab(" ") + 
  ylab("Percent of Citi Bike trips") + 
  ggtitle("Most popular Citi Bike stations in 2017")

# impact: we can tell the Citi Bike stations are well spread out. There aren't any stations that are excessively impacted, although there are some lesser used ones.

```


```{r importCarCrashData, message = FALSE, warning = FALSE}
nyc_crashes <- read_csv("NYPD_Motor_Vehicle_Collisions.csv")

#this CSV should be in the zip file of the project. It will not work if it is not in the zip file.
```

```{r renameColumns, message = FALSE, warning = FALSE}
colnames(nyc_crashes)[4] <- "zip_code"
colnames(nyc_crashes)[8] <- "street_name"
colnames(nyc_crashes)[9] <- "cross_street_name"
colnames(nyc_crashes)[10] <- "off_street_name"
colnames(nyc_crashes)[15] <- "bike_injuries"
colnames(nyc_crashes)[16] <- "bike_deaths"
colnames(nyc_crashes)[11] <- "pers_inj"
colnames(nyc_crashes)[12] <- "pers_killed"
colnames(nyc_crashes)[13] <- "ped_inj"
colnames(nyc_crashes)[14] <- "ped_killed"
```

```{r FilterForBikeCrashOnly, message = FALSE, warning = FALSE}
nyc_crashes_bike <- nyc_crashes %>%
  filter(bike_injuries > 0 | bike_deaths > 0) 
  
```


```{r GetDatesForCrashData, message = FALSE, warning = FALSE}
bike_crashes_tidy <- nyc_crashes_bike %>%
  dplyr::select(DATE, LONGITUDE, LATITUDE, bike_injuries, bike_deaths) %>%
  dplyr::mutate(FullDate = mdy(DATE)) %>%
  separate(FullDate, sep="-", into = c("year", "month", "day")) %>%
  filter(LONGITUDE != 0, LATITUDE != 0) %>%
  filter(year == 2019 | year == 2018 | year == 2017)
```


```{r icons, message = FALSE, warning = FALSE}
bike_icon <- icons(iconUrl = "bike_icon.png", 15, 15)
```


```{r LeafletMap, message = FALSE, warning = FALSE}
leaflet(bikeStations) %>%
  addTiles() %>%
  addMarkers(~bikeStations$lon, ~bikeStations$lat, icon = bike_icon) %>%
  addCircles(~bike_crashes_tidy$LONGITUDE, bike_crashes_tidy$LATITUDE, weight = 1.5, radius = 20,
             fill = ~bike_crashes_tidy$bike_deaths, color = 'red', stroke = TRUE, fillOpacity = 1)
```


```{r tweets, message = FALSE, warning = FALSE}
citibike <- search_tweets("citibike nyc", n = 1000, include_rts = FALSE)
# you can only collect a handful of tweets but it refreshes every 15 minutes. DON'T ALWAYS RUN. you might need a twitter account of mine doesn't let you do it
```

```{r wrangleYeehaw, message = FALSE, warning = FALSE}
citibikeSimple <- citibike %>%
  select(status_id, screen_name, created_at, text, display_text_width, favorite_count, retweet_count, hashtags) %>%
  mutate(month = month(created_at, label = TRUE)) %>%
  mutate(day = day(created_at)) %>%
  mutate(hour = hour(created_at))

```

```{r plotTweets, message = FALSE, warning = FALSE}
ggplot(citibikeSimple, aes(x = hour, y = favorite_count, color = display_text_width)) + 
  geom_point() + 
  scale_color_gradient(low="blue", high="red") +
  theme_classic()

#this shows how many likes that each tweet recieved. Most likes occured during the rush hour of 4 to 8 pm

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


^[[Github Repository](https://github.com/SarahGillespie/sds192-mp4)
]
